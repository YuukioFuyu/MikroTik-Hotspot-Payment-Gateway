<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="-1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>[Yuuki0] NETWORK - Log in</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body class="bgstill">

  <!-- POPUP LOADING -->
    <div id="loadingPopup" class="modal hidden">
        <div class="modal-content">
            <div class="spinner"></div>
            <h2>⏳ Connecting...</h2>
            <p>Processing your request to the server.</p>
        </div>
    </div>

  <!-- POPUP ERROR -->
  <div id="errorPopup" class="modal hidden">
    <div class="modal-content">
      <span class="close-button" onclick="closePopup()">&times;</span>
      <h2>⚠️ An Error Occurred</h2>
      <p id="errorMessage">Something went wrong.</p>
      <p id="errorDetail" class="detail hidden">...</p>
      <button onclick="refreshLoginPage()">Refresh</button>
    </div>
  </div>

  <!-- Mikrotik CHAP login -->
  $(if chap-id)
  <form name="sendin" action="$(link-login-only)" method="post" style="display:none">
    <input type="hidden" name="username" />
    <input type="hidden" name="password" />
    <input type="hidden" name="dst" value="$(link-orig)" />
    <input type="hidden" name="popup" value="true" />
  </form>

  <script src="/md5.js"></script>
  <script>
    function doLogin() {
      document.sendin.username.value = document.login.username.value;
      document.sendin.password.value = hexMD5('$(chap-id)' + document.login.password.value + '$(chap-challenge)');
      document.sendin.submit();
      return false;
    }
  </script>
  $(endif)

  <div class="ie-fixMinHeight">
    <div class="main">
      <div class="wrap animated fadeIn">
        <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
          <input type="hidden" name="dst" value="$(link-orig)" />
          <input type="hidden" name="popup" value="true" />

          <div class="logo"></div>

          <p class="info $(if error)alert$(endif)">
            $(if error == "")Please login to use the internet hotspot service$(endif)
            $(if error)$(error)$(endif)
          </p>

          <label>
            <img class="ico" src="img/user.svg" alt="#" />
            <input name="username" type="text" value="$(username)" placeholder="Username" />
          </label>

          <label>
            <img class="ico" src="img/password.svg" alt="#" />
            <input name="password" type="password" placeholder="Password" />
          </label>

          <input type="submit" value="Login" />

          <p class="info $(if error)alert$(endif)">
            $(if trial == 'yes')<br />
            <p class="info highlight">
                Don't have an account?<br />
                <a id="guestLogin" class="cta-button" href="#">Login as Guest</a>
            </p>
            $(endif)
          </p>
        </form>
        <p class="info bt">Powered by [Yuuki0] NETWORK</p>
      </div>
    </div>
  </div>

  <script>
    function showLoading() {
        const popup = document.getElementById("loadingPopup");
        popup.classList.remove("hidden", "fade-out");
        popup.classList.add("fade-in");
        }

        function hideLoading() {
        const popup = document.getElementById("loadingPopup");
        popup.classList.remove("fade-in");
        popup.classList.add("fade-out");

        setTimeout(() => {
            popup.classList.add("hidden");
            popup.classList.remove("fade-out");
        }, 300);
    }

    function showError(message) {
        const popup = document.getElementById("errorPopup");
        const messageBox = document.getElementById("errorMessage");

        messageBox.textContent = message;
        popup.classList.remove("hidden", "fade-out");
        popup.classList.add("fade-in");
    }

    function showError(message, detail = "") {
        const popup = document.getElementById("errorPopup");
        const messageBox = document.getElementById("errorMessage");
        const detailBox = document.getElementById("errorDetail");

        messageBox.textContent = message;

        if (detail) {
            detailBox.textContent = detail;
            detailBox.classList.remove("hidden");
        } else {
            detailBox.classList.add("hidden");
        }

        popup.classList.remove("hidden", "fade-out");
        popup.classList.add("fade-in");
    }

    function closePopup() {
        const modal = document.getElementById("errorPopup");
        modal.classList.remove("fade-in");
        modal.classList.add("fade-out");
        setTimeout(() => {
        modal.classList.add("hidden");
        modal.classList.remove("fade-out");
        }, 300);
    }

    function refreshLoginPage() {
        location.reload();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const guestBtn = document.getElementById("guestLogin");

        if (guestBtn) {
        guestBtn.addEventListener("click", async (e) => {
            e.preventDefault();

            const mac = '$(mac-esc)';
            const timestamp = Math.floor(Date.now() / 1000);

            try {
                showLoading();

                const res = await fetch(`https://hotspot.yuuki0.net/preauth?timestamp=${timestamp}&mac=${mac}`);
                if (!res.ok) throw new Error("Unable to contact server.");

                const { token } = await res.json();
                if (!token) throw new Error("Token tidak valid.");

                hideLoading();
                window.location.href = `payment.htm?timestamp=${timestamp}&token=${encodeURIComponent(token)}&mac=${mac}`;

            } catch (err) {
                hideLoading();
                console.error("Failed to create token:", err);
                showError(
                  "Failed to start the payment process.",
                  "Please make sure your internet connection is stable. The system requires a connection to create a payment token via eWallet or Virtual Account."
                );
            }
            });
        }
    });
    </script>

</body>

</html>